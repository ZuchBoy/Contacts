@page "/register"
@using ContactsFront.Api
@using ContactsFront.Services
@using ContactsFront.Models
@inject AuthService Auth
@inject NavigationManager NavManager

<h3>Register</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}

<div class="form-group">
    <label>First Name</label>
    <input class="form-control" @bind="model.FirstName" />
</div>

<div class="form-group">
    <label>Surname</label>
    <input class="form-control" @bind="model.Surname" />
</div>

<div class="form-group">
    <label>Email</label>
    <input class="form-control" type="email" @bind="model.Email" />
</div>

<div class="form-group">
    <label>Category</label>
    <select class="form-control" @bind="model.CategoryId">
        <option value="1">Służbowy</option>
        <option value="2">Prywatny</option>
        <option value="3">Inny</option>
    </select>
</div>

<div class="form-group">
    <label>Password</label>
    <input class="form-control" @bind="model.Password" type="password" />
</div>

<button class="btn btn-primary" @onclick="HandleRegister">Register</button>

@code {
    private RegisterModel model = new();
    private string errorMessage = string.Empty;

    private async Task HandleRegister()
    {
        errorMessage = string.Empty;

        if (string.IsNullOrEmpty(model.FirstName) ||
            string.IsNullOrEmpty(model.Surname) ||
            string.IsNullOrEmpty(model.Email) ||
            string.IsNullOrEmpty(model.Password) ||
            model.CategoryId == 0)
        {
            errorMessage = "All fields are required.";
            return;
        }

        // Password security check
        if (model.Password.Length < 8 ||
            !model.Password.Any(char.IsDigit) ||
            !model.Password.Any(ch => !char.IsLetterOrDigit(ch)))
        {
            errorMessage = "Password must have at least 8 characters, one digit and one special symbol.";
            return;
        }

        try
        {
            await Auth.RegisterAsync(model);
            NavManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }
}
